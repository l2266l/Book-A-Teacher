<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      text-align: center;
      padding: 50px;
    }

    .admin-content {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      max-width: 900px;
      margin: auto;
    }

    h1 {
      color: #0077b6;
    }

    .counter {
      margin-top: 20px;
      font-size: 1.2rem;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #0077b6;
      color: white;
    }

    a {
      color: #0077b6;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .status-badge {
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
      color: white;
    }

    .approved {
      background-color: #2a9d8f;
    }

    .pending {
      background-color: #e76f51;
    }

    button.approve-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: white;
    }

    button.approve-btn.approve {
      background-color: #2a9d8f;
    }

    button.approve-btn.undo {
      background-color: #e76f51;
    }
  </style>
</head>
<body>

  <div class="admin-content" id="adminContent">
    <h1>Admin Dashboard</h1>
    <p>Welcome, Admin. You now have access to restricted data and controls.</p>
    
    <div class="counter">
      <p>Parent/Student Accounts: <span id="parentCount">0</span></p>
      <p>Teacher Accounts: <span id="teacherCount">0</span></p>
      <p>Website Visits: <span id="visitCount">0</span></p>
    </div>

    <table id="teachersTable" aria-label="Teachers List">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>University Certificate</th>
          <th>Payment Receipt</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Teacher rows inserted here -->
      </tbody>
    </table>
    <p id="noTeachersMsg" style="margin-top: 20px; color: #666; display:none;">No teachers signed up yet.</p>
  </div>

  <script>
    const adminPassword = "SJ";

    const userInput = prompt("Enter admin password:");
    if (userInput !== adminPassword) {
      alert("Access denied.");
      window.location.href = "index.html";
    } else {
      document.getElementById("adminContent").style.display = "block";
    }

    let visitCount = localStorage.getItem("visitCount") || 0;
    visitCount = Number(visitCount) + 1;
    localStorage.setItem("visitCount", visitCount);
    document.getElementById("visitCount").innerText = visitCount;

    let parentAccounts = [];
    try {
      const storedParents = localStorage.getItem("parents");
      if (storedParents) parentAccounts = JSON.parse(storedParents);
    } catch (e) {
      console.error("Error parsing parents from localStorage", e);
    }

    let teachers = [];
    try {
      const storedTeachers = localStorage.getItem("teachers");
      if (storedTeachers) {
        teachers = JSON.parse(storedTeachers);
      } else {
        teachers = [
          {
            name: "Zahra Al Ali",
            email: "zahra@univ.com",
            certificateUrl: "https://example.com/cert.jpg",
            receiptUrl: "https://example.com/receipt.jpg",
            approved: false,
            subject: "math"
          }
        ];
        localStorage.setItem("teachers", JSON.stringify(teachers));
      }
    } catch (e) {
      console.error("Error parsing teachers from localStorage", e);
    }

    document.getElementById("parentCount").innerText = parentAccounts.length;
    document.getElementById("teacherCount").innerText = teachers.length;

    const teachersTableBody = document.querySelector("#teachersTable tbody");
    const noTeachersMsg = document.getElementById("noTeachersMsg");

    function escapeHTML(str) {
      if (!str) return "";
      return str.replace(/[&<>"']/g, function(m) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        })[m];
      });
    }

    function renderTeachers() {
      teachersTableBody.innerHTML = "";
      if (teachers.length === 0) {
        noTeachersMsg.style.display = "block";
        return;
      } else {
        noTeachersMsg.style.display = "none";
      }

      teachers.forEach((teacher, index) => {
        const name = escapeHTML(teacher.name || "");
        const email = escapeHTML(teacher.email || "");
        const certUrl = teacher.certificateUrl || "";
        const receiptUrl = teacher.receiptUrl || "";
        const approved = !!teacher.approved;

        const certLink = certUrl
          ? `<a href="${encodeURI(certUrl)}" target="_blank" rel="noopener noreferrer">View Certificate</a>`
          : "N/A";

        const receiptLink = receiptUrl
          ? `<a href="${encodeURI(receiptUrl)}" target="_blank" rel="noopener noreferrer">View Receipt</a>`
          : "N/A";

        const statusBadge = approved
          ? `<span class="status-badge approved">Approved</span>`
          : `<span class="status-badge pending">Pending</span>`;

        const actionBtnText = approved ? "Undo" : "Approve";
        const actionBtnClass = approved ? "undo" : "approve";

        teachersTableBody.insertAdjacentHTML("beforeend", 
          `<tr>
            <td>${name}</td>
            <td>${email}</td>
            <td>${certLink}</td>
            <td>${receiptLink}</td>
            <td>${statusBadge}</td>
            <td><button class="approve-btn ${actionBtnClass}" data-index="${index}">${actionBtnText}</button></td>
          </tr>`
        );
      });
    }

    // ðŸ†• Update approved teachers under subjects
    function updateApprovedTeachersBySubject() {
      const approvedBySubject = {};
      teachers.forEach(t => {
        if (t.approved && t.subject) {
          if (!approvedBySubject[t.subject]) {
            approvedBySubject[t.subject] = [];
          }
          approvedBySubject[t.subject].push(t);
        }
      });
      localStorage.setItem("approvedTeachersBySubject", JSON.stringify(approvedBySubject));
    }

    teachersTableBody.addEventListener("click", e => {
      if (e.target.classList.contains("approve-btn")) {
        const idx = parseInt(e.target.getAttribute("data-index"), 10);
        if (isNaN(idx) || idx < 0 || idx >= teachers.length) return;

        teachers[idx].approved = !teachers[idx].approved;
        localStorage.setItem("teachers", JSON.stringify(teachers));
        updateApprovedTeachersBySubject(); // ðŸ†• Sync approved list
        renderTeachers();
      }
    });

    renderTeachers();
  </script>
</body>
</html>
